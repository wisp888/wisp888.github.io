<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hive搭建</title>
    <url>/2019/12/12/Hive%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<p>在hadoop的基础安装hive，我在node-1上面安装hive</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li>hadoop环境</li>
<li>Mysql服务</li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar xvf apache-hive-3.1.2-bin.tar.gz</span><br><span class="line">mv apache-hive-3.1.2 /usr/<span class="built_in">local</span>/hive</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/profile &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line"><span class="built_in">export</span> HIVE_HOME=/usr/<span class="built_in">local</span>/hive</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HIVE_HOME</span>/bin</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>hive的主要配置目录在: /usr/local/hive/conf</p>
<h4 id="hive-env-sh"><a href="#hive-env-sh" class="headerlink" title="hive-env.sh"></a>hive-env.sh</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp hive-env.sh.template hive-env.sh</span><br></pre></td></tr></table></figure>

<p>修改配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">HADOOP_HOME=/usr/local/hadoop</span><br><span class="line">export HIVE_CONF_DIR=/usr/local/hive/conf</span><br></pre></td></tr></table></figure>

<h4 id="hive-site-xml"><a href="#hive-site-xml" class="headerlink" title="hive-site.xml"></a>hive-site.xml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp hive-default.xml.template hive-site.xml</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/hive/tmp -p</span><br></pre></td></tr></table></figure>

<p>修改hive-site.xml</p>
<ul>
<li>删除  ‘&amp;#8’</li>
<li>把 ${system:java.io.tmpdir} 修改成 /usr/local/apache-hive-3.1.2-bin/tmp；修改的操作命令如下（采用的vim全局替换命令）：%s/${system:java.io.tmpdir}//usr/local/apache-hive-3.1.2-bin/tmp/g；</li>
<li>把 {system:user.name} 修改成 {user.name}；修改的操作命令如下（采用的vim全局替换命令）：%s/{system:user.name}/{user.name}/g；</li>
</ul>
<p>修改数据库连接配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://localhost:3306/hive?characterEncoding=UTF-8&amp;amp;createDatabaseIfNotExist=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>******<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改hive-jdbc连接配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.thrift.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>10000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.thrift.bind.host<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改客户端连接认证方式</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.authentication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>NOSASL<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="添加Mysql连接驱动"><a href="#添加Mysql连接驱动" class="headerlink" title="添加Mysql连接驱动"></a>添加Mysql连接驱动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -ivh mysql-connector-java-8.0.18-1.el7.noarch.rpm</span><br><span class="line">cp /usr/share/java/mysql-connector-java.jar /usr/<span class="built_in">local</span>/hive/lib/</span><br></pre></td></tr></table></figure>

<h3 id="更新guava-jar包"><a href="#更新guava-jar包" class="headerlink" title="更新guava.jar包"></a>更新guava.jar包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/hadoop/share/hadoop/hdfs/lib/guava-27.0-jre.jar  /usr/<span class="built_in">local</span>/hive/lib/</span><br><span class="line">rm -f /usr/<span class="built_in">local</span>/hive/lib/guava-19.0.jar</span><br></pre></td></tr></table></figure>

<h3 id="初始化元数据"><a href="#初始化元数据" class="headerlink" title="初始化元数据"></a>初始化元数据</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">schematool -dbType mysql -initSchema --verbose</span><br></pre></td></tr></table></figure>

<h3 id="启动hive"><a href="#启动hive" class="headerlink" title="启动hive"></a>启动hive</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/hive</span><br><span class="line">./bin/hive --service metastore &amp;</span><br><span class="line">./bin/hive --service hiveserver2 &amp;</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">create external table <span class="keyword">if</span> not exists testExtNew(</span><br><span class="line">name string,</span><br><span class="line">addr string</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by <span class="string">'\t'</span> </span><br><span class="line">lines terminated by <span class="string">'\n'</span> </span><br><span class="line">stored as textfile</span><br><span class="line">location <span class="string">'/wisp/test/'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from testExtNew;</span><br></pre></td></tr></table></figure>

<h4 id="上传数据"><a href="#上传数据" class="headerlink" title="上传数据"></a>上传数据</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node-1 data]<span class="comment"># cat test.txt </span></span><br><span class="line">wisp	aaaaaaaaaa</span><br><span class="line">lhp	bbbbbbb</span><br><span class="line"><span class="built_in">test</span>	cccccccccc</span><br><span class="line">tttt	asdfasf</span><br><span class="line">tttt	asdfasf</span><br><span class="line">tsadfasdf	asddddddd1fasf</span><br><span class="line"></span><br><span class="line">[root@node-1 data]<span class="comment"># hadoop fs -put /data/test.txt /wisp/test/</span></span><br><span class="line">[root@node-1 data]<span class="comment"># hive</span></span><br><span class="line">hive&gt; select * from testExtNew;</span><br><span class="line">OK</span><br><span class="line">tttt	asdfasf</span><br><span class="line">tttt	asdfasf</span><br><span class="line">tsadfasdf	asddddddd1fasf</span><br><span class="line">wisp	aaaaaaaaaa</span><br><span class="line">lhp	bbbbbbb</span><br><span class="line"><span class="built_in">test</span>	cccccccccc</span><br></pre></td></tr></table></figure>

<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><ul>
<li>Hive数据加载：<a href="https://blog.csdn.net/scgaliguodong123_/article/details/46906427" target="_blank" rel="noopener">https://blog.csdn.net/scgaliguodong123_/article/details/46906427</a></li>
</ul>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>centos7</tag>
        <tag>hadoop</tag>
        <tag>hive</tag>
      </tags>
  </entry>
  <entry>
    <title>Hadoop集群搭建</title>
    <url>/2019/12/12/Hadoop%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<p>在Centos7系统上进行安装，采用hadoop3.2.1</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><table>
<thead>
<tr>
<th>IP</th>
<th>名称</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.9.214</td>
<td>node-1</td>
<td>ResourceManager<br />NameNode<br />DataNode<br />NodeManager</td>
</tr>
<tr>
<td>192.168.9.215</td>
<td>node-2</td>
<td>SecondaryNameNode<br />NodeManager<br />DataNode</td>
</tr>
<tr>
<td>192.168.9.216</td>
<td>node-3</td>
<td>NodeManager<br />DataNode</td>
</tr>
</tbody></table>
<h4 id="修改机器名"><a href="#修改机器名" class="headerlink" title="修改机器名"></a>修改机器名</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hostnamectl <span class="built_in">set</span>-hostname node-1/node-2/node-3</span><br></pre></td></tr></table></figure>

<h4 id="设置HOSTS"><a href="#设置HOSTS" class="headerlink" title="设置HOSTS"></a>设置HOSTS</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.9.214 node-1</span><br><span class="line">192.168.9.215 node-2</span><br><span class="line">192.168.9.216 node-3</span><br></pre></td></tr></table></figure>

<h4 id="配置免密码登陆"><a href="#配置免密码登陆" class="headerlink" title="配置免密码登陆"></a>配置免密码登陆</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在node-1中：</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id node-2</span><br><span class="line">ssh-copy-id node-3</span><br></pre></td></tr></table></figure>

<h4 id="关闭防火墙、selinux"><a href="#关闭防火墙、selinux" class="headerlink" title="关闭防火墙、selinux"></a>关闭防火墙、selinux</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line">systemctl stop iptables</span><br><span class="line">systemctl <span class="built_in">disable</span> iptables</span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h4 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar xvf jdk-8u221-linux-x64.tar.gz</span><br><span class="line">mv jdk1.8.0_221 /usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/profile &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.8.0_221</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="安装配置Hadoop"><a href="#安装配置Hadoop" class="headerlink" title="安装配置Hadoop"></a>安装配置Hadoop</h3><h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar xvf hadoop-3.2.1.tar.gz</span><br><span class="line">mv hadoop-3.2.1 /usr/<span class="built_in">local</span>/hadoop</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/profile &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_HOME=/usr/<span class="built_in">local</span>/hadoop</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/bin </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/sbin</span><br><span class="line"><span class="built_in">export</span> HADOOP_COMMON_LIB_NATIVE_DIR=<span class="variable">$HADOOP_HOME</span>/lib/native</span><br><span class="line"><span class="built_in">export</span> HADOOP_OPTS=<span class="string">"-Djava.library.path=<span class="variable">$HADOOP_HOME</span>/lib:<span class="variable">$HADOOP_COMMON_LIB_NATIVE_DIR</span>"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h4><p>配置文件全部放在/usr/local/hadoop/etc/hadoop目录下</p>
<h5 id="hadoop-env-sh"><a href="#hadoop-env-sh" class="headerlink" title="hadoop-env.sh"></a>hadoop-env.sh</h5><p>增加JDK路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_221</span><br></pre></td></tr></table></figure>

<h5 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 指定hadoop运行时产生文件的存储目录,可以指定自己熟悉的目录，默认/tmp/hadoop-$&#123;user.name&#125; --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/data/hadoop/data/hddata<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Abase for other temporary directories.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 指定hadoop使用的文件系统，HDFS的老大NameNode的地址 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://node-1:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.proxyuser.root.hosts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>*<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.proxyuser.root.groups<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>*<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 其他机器也要创建</span></span><br><span class="line">mkdir -p /data/hadoop/data/hddata</span><br></pre></td></tr></table></figure>

<h5 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定HDFS副本数量，默认3 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">value</span>&gt;</span>3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>node-2:50090<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/data/hadoop/hdfs/name<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/data/hadoop/hdfs/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 其他机器也要创建</span></span><br><span class="line">mkdir -p /data/hadoop/hdfs/name</span><br><span class="line">mkdir -p /data/hadoop/hdfs/data</span><br></pre></td></tr></table></figure>

<h5 id="mapred-site-xml"><a href="#mapred-site-xml" class="headerlink" title="mapred-site.xml"></a>mapred-site.xml</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 指定mapred运行时的框架：yarn，默认local --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapred.job.tracker<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>http://node-1:9001<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="yarn-site-xml"><a href="#yarn-site-xml" class="headerlink" title="yarn-site.xml"></a>yarn-site.xml</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Site specific YARN configuration properties --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 指定yarn（老大）的地址（ResourceManager） --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>node-1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- nodemanager上运行的附属服务，指定mapreduce_shuffle才可以运行mapReduce默认 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="slaves"><a href="#slaves" class="headerlink" title="slaves"></a>slaves</h5><p>删除内容添加机器：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node-1</span><br><span class="line">node-2</span><br><span class="line">node-3</span><br></pre></td></tr></table></figure>

<h5 id="workers"><a href="#workers" class="headerlink" title="workers"></a>workers</h5><p>删除内容添加机器， 这份配置是允许哪些机器启动data节点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node-1</span><br><span class="line">node-2</span><br><span class="line">node-3</span><br></pre></td></tr></table></figure>

<h4 id="同步文件到其他服务器"><a href="#同步文件到其他服务器" class="headerlink" title="同步文件到其他服务器"></a>同步文件到其他服务器</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rsync -avzP /uar/<span class="built_in">local</span>/hadoop root@node-2:/usr/<span class="built_in">local</span>/</span><br><span class="line">rsync -avzP /uar/<span class="built_in">local</span>/hadoop root@node-3:/usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line">scp /etc/profile root@node-2:/etc</span><br><span class="line">scp /etc/profile root@node-3:/etc</span><br></pre></td></tr></table></figure>

<h3 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h3><h4 id="格式化dhfs"><a href="#格式化dhfs" class="headerlink" title="格式化dhfs"></a>格式化dhfs</h4><p>格式化只能在初始启动之前启动一次，是对文件系统进行一些初始化操作，因为此时hdfs还不存在；在初始化完成之后，集群启动，之后不能再进行初始化</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hdfs namenode -format</span><br></pre></td></tr></table></figure>

<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/local/hadoop</span><br><span class="line">./sbin/start-all.sh</span><br></pre></td></tr></table></figure>

<h4 id="检查服务"><a href="#检查服务" class="headerlink" title="检查服务"></a>检查服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node-1 hadoop]<span class="comment"># jps</span></span><br><span class="line">12996 NodeManager</span><br><span class="line">12231 NameNode</span><br><span class="line">12409 DataNode</span><br><span class="line">24748 Jps</span><br><span class="line">12782 ResourceManager</span><br><span class="line"></span><br><span class="line">[root@node-2 ~]<span class="comment"># jps</span></span><br><span class="line">18001 DataNode</span><br><span class="line">21990 Jps</span><br><span class="line">18106 SecondaryNameNode</span><br><span class="line">18186 NodeManager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node-3 ~]<span class="comment"># jps</span></span><br><span class="line">18001 DataNode</span><br><span class="line">21990 Jps</span><br><span class="line">18186 NodeManager</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hdfs dfs -ls /</span><br><span class="line">hdfs dfs  -mkdir /wisp</span><br><span class="line">hdfs dfs -ls /</span><br></pre></td></tr></table></figure>

<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><ul>
<li>ResourceManager页面：<a href="http://192.168.9.214:8088/" target="_blank" rel="noopener">http://192.168.9.214:8088/</a></li>
<li>Hadoop HDFS文件操作：<a href="https://segmentfault.com/a/1190000002672666" target="_blank" rel="noopener">https://segmentfault.com/a/1190000002672666</a></li>
</ul>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>centos7</tag>
        <tag>hadoop</tag>
      </tags>
  </entry>
  <entry>
    <title>golang iris 学习三: casbin权限验证</title>
    <url>/2019/12/03/golang-iris-%E5%AD%A6%E4%B9%A0%E4%B8%89-casbin%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<p><a href="https://casbin.org/docs/zh-CN/tutorials" target="_blank" rel="noopener">Casbin官方教程</a> </p>
<p>撸个简单的权限系统：用户包含角色， 角色包含权限</p>
<h3 id="先定义一份简单的权限规则库"><a href="#先定义一份简单的权限规则库" class="headerlink" title="先定义一份简单的权限规则库"></a>先定义一份简单的权限规则库</h3><p>相当于定义菜单权限</p>
<p>casbin.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[request_definition]</span><br><span class="line">r = sub, obj, act</span><br><span class="line"></span><br><span class="line">[policy_definition]</span><br><span class="line">p = sub, obj, act</span><br><span class="line"></span><br><span class="line">[policy_effect]</span><br><span class="line">e = some(where (p.eft == allow))</span><br><span class="line"></span><br><span class="line">[matchers]</span><br><span class="line">m = r.sub == p.sub &amp;&amp; keyMatch(r.obj, p.obj) &amp;&amp; (p.act == &quot;*&quot; || regexMatch(r.act, p.act))</span><br></pre></td></tr></table></figure>

<ul>
<li>request_definition: 可以理解为验证函数传进去的参数</li>
<li>policy_definition: 可以理解为添加规则函数传进去的参数，就是存进数据库的数据规则</li>
<li>policy_effect: 对结果进行判定</li>
<li>matchers: 匹配规则</li>
</ul>
<p>先测试一下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    enforcer := datasource.GetEnforce()</span><br><span class="line"></span><br><span class="line">    // 添加规则</span><br><span class="line">    ok, err := enforcer.AddPolicy(&quot;测试&quot;, &quot;test.a1&quot;, &quot;test&quot;, &quot;/test/a1&quot;, &quot;get&quot;)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(&quot;添加规则：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    // 测试规则</span><br><span class="line">    ok, err = enforcer.Enforce(&quot;test.a1&quot;, &quot;/test/a1&quot;, &quot;get&quot;)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(&quot;规则测试：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    ok, err = enforcer.Enforce(&quot;test.a1&quot;, &quot;/test/a111&quot;, &quot;get&quot;)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(&quot;规则测试：%v\n&quot;, ok)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">添加规则：true</span><br><span class="line">规则测试：true</span><br><span class="line">规则测试：false</span><br></pre></td></tr></table></figure>

<h3 id="增加组的权限"><a href="#增加组的权限" class="headerlink" title="增加组的权限"></a>增加组的权限</h3><p>相当于角色权限 和 用户权限</p>
<p>casbin.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[request_definition]</span><br><span class="line">r = sub, obj, act</span><br><span class="line"></span><br><span class="line">[policy_definition]</span><br><span class="line">p = sub, obj, act</span><br><span class="line"></span><br><span class="line">[policy_effect]</span><br><span class="line">e = some(where (p.eft == allow))</span><br><span class="line"></span><br><span class="line">[role_definition]</span><br><span class="line">g = _, _</span><br><span class="line"></span><br><span class="line">[matchers]</span><br><span class="line">m = g(r.sub, p.sub) &amp;&amp; keyMatch(r.obj, p.obj) &amp;&amp; (p.act == &quot;*&quot; || regexMatch(r.act, p.act))</span><br></pre></td></tr></table></figure>

<ul>
<li>role_definition: 分组功能</li>
</ul>
<p>测试代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;goms/datasource&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    enforcer := datasource.GetEnforce()</span><br><span class="line"></span><br><span class="line">    // 添加规则</span><br><span class="line">    ok, err := enforcer.AddPolicy(&quot;test.a1&quot;, &quot;/test/a1&quot;, &quot;get&quot;)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(&quot;添加规则：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    // 测试规则</span><br><span class="line">    ok, err = enforcer.Enforce(&quot;test.a1&quot;, &quot;/test/a1&quot;, &quot;get&quot;)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(&quot;规则测试：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    ok, err = enforcer.Enforce(&quot;test.a1&quot;, &quot;/test/a111&quot;, &quot;get&quot;)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(&quot;规则测试：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    // 添加角色</span><br><span class="line">    ok, _ = enforcer.AddGroupingPolicy(&quot;yy&quot;, &quot;test.a1&quot;)</span><br><span class="line">    fmt.Printf(&quot;添加角色：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    // 测试角色</span><br><span class="line">    ok, _ = enforcer.Enforce(&quot;yy&quot;, &quot;/test/a1&quot;, &quot;get&quot;)</span><br><span class="line">    fmt.Printf(&quot;规则测试：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    ok, _ = enforcer.Enforce(&quot;yy&quot;, &quot;/test/a111&quot;, &quot;get&quot;)</span><br><span class="line">    fmt.Printf(&quot;规则测试：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    // 添加用户</span><br><span class="line">    ok, _ = enforcer.AddGroupingPolicy(&quot;wisp&quot;, &quot;yy&quot;)</span><br><span class="line">    fmt.Printf(&quot;添加角色：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    // 测试用户</span><br><span class="line">    ok, _ = enforcer.Enforce(&quot;wisp&quot;, &quot;/test/a1&quot;, &quot;get&quot;)</span><br><span class="line">    fmt.Printf(&quot;规则测试：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    ok, _ = enforcer.Enforce(&quot;wisp&quot;, &quot;/test/a111&quot;, &quot;get&quot;)</span><br><span class="line">    fmt.Printf(&quot;规则测试：%v\n&quot;, ok)</span><br><span class="line"></span><br><span class="line">    // 查询</span><br><span class="line">    ret := enforcer.GetFilteredPolicy(0, &quot;test.a1&quot;)</span><br><span class="line">    fmt.Println(ret)</span><br><span class="line"></span><br><span class="line">    ret = enforcer.GetFilteredGroupingPolicy(0, &quot;yy&quot;)</span><br><span class="line">    fmt.Println(ret)</span><br><span class="line"></span><br><span class="line">    ret = enforcer.GetFilteredGroupingPolicy(0, &quot;wisp&quot;)</span><br><span class="line">    fmt.Println(ret)</span><br><span class="line">&#125;</span><br><span class="line">---</span><br><span class="line">添加规则：false</span><br><span class="line">规则测试：true</span><br><span class="line">规则测试：false</span><br><span class="line">添加角色：false</span><br><span class="line">规则测试：true</span><br><span class="line">规则测试：false</span><br><span class="line">添加角色：true</span><br><span class="line">规则测试：true</span><br><span class="line">规则测试：false</span><br><span class="line">[[test.a1 /test/a1 get]]</span><br><span class="line">[[yy test.a1]]</span><br><span class="line">[[wisp yy]]</span><br></pre></td></tr></table></figure>

<p>很简单，wisp拥有yy角色，yy角色包含test.a1 /test/a1 get 权限</p>
<p>怎么结合到iris里面去呢，想来想去也想不懂，总不能把用户系统写到casbin里面来吧，要不就添加用户权限的时候更新一下casbin数据库，要不就登陆或者刷新的时候把用户权限写进casbin数据库，感觉麻，还是后面这种方便一点</p>
<h3 id="先增加一份初始化代码"><a href="#先增加一份初始化代码" class="headerlink" title="先增加一份初始化代码"></a>先增加一份初始化代码</h3><p>datasource/casbin.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> datasource</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/casbin/casbin/v2"</span></span><br><span class="line">	mongodbadapter <span class="string">"github.com/casbin/mongodb-adapter/v2"</span></span><br><span class="line">	<span class="string">"goms/config"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Enforcer *casbin.Enforcer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mongoInfo := config.GConfig.Mongo</span><br><span class="line">	mongoUrl := fmt.Sprintf(<span class="string">"mongodb://%s:%d/%s"</span>, mongoInfo.Host, mongoInfo.Port, mongoInfo.Name)</span><br><span class="line">	a := mongodbadapter.NewAdapter(mongoUrl)</span><br><span class="line"></span><br><span class="line">	e, err := casbin.NewEnforcer(<span class="string">"casbin.conf"</span>, a)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	e.LoadPolicy()</span><br><span class="line">	e.EnableAutoSave(<span class="literal">true</span>)</span><br><span class="line">	Enforcer = e</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetEnforce</span><span class="params">()</span> *<span class="title">casbin</span>.<span class="title">Enforcer</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Enforcer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="增加casbin规则的增加、删除方法"><a href="#增加casbin规则的增加、删除方法" class="headerlink" title="增加casbin规则的增加、删除方法"></a>增加casbin规则的增加、删除方法</h3><p>repo/login_repo.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> repo</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"goms/datamodels"</span></span><br><span class="line">	<span class="string">"goms/datasource"</span></span><br><span class="line">	<span class="string">"gopkg.in/mgo.v2/bson"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LoginRepository <span class="keyword">interface</span> &#123;</span><br><span class="line">	Check(query bson.M) (user datamodels.User, err error)</span><br><span class="line">	RemovePolicy(userID <span class="keyword">string</span>) (err error)</span><br><span class="line">	LoadPolicy(userID <span class="keyword">string</span>, menu datamodels.Menu) (err error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> loginRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">	collection <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLoginRepository</span><span class="params">()</span> <span class="title">LoginRepository</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;loginRepository&#123;collection: <span class="string">"project_user"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *loginRepository)</span> <span class="title">Check</span><span class="params">(query bson.M)</span> <span class="params">(user datamodels.User, err error)</span></span> &#123;</span><br><span class="line">	db := datasource.NewSessionStore()</span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line">	col := db.C(l.collection)</span><br><span class="line"></span><br><span class="line">	err = col.Find(query).One(&amp;user)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !user.IsActive &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">"该用户已被禁用！"</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *loginRepository)</span> <span class="title">RemovePolicy</span><span class="params">(userID <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	enforcer := datasource.GetEnforce()</span><br><span class="line">	_, err = enforcer.RemoveFilteredPolicy(<span class="number">0</span>, userID)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *loginRepository)</span> <span class="title">LoadPolicy</span><span class="params">(userID <span class="keyword">string</span>, menu datamodels.Menu)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	enforcer := datasource.GetEnforce()</span><br><span class="line">	<span class="keyword">for</span> _, permission := <span class="keyword">range</span> menu.Permission &#123;</span><br><span class="line">		<span class="keyword">if</span> permission.Url == <span class="string">""</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		_, err = enforcer.AddPolicy(userID, permission.Url, permission.Method)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要就是利用casbin的两个API：</p>
<ul>
<li>enforcer.RemoveFilteredPolicy</li>
<li>enforcer.AddPolicy</li>
</ul>
<h3 id="用户刷新的时候更新一次casbin权限"><a href="#用户刷新的时候更新一次casbin权限" class="headerlink" title="用户刷新的时候更新一次casbin权限"></a>用户刷新的时候更新一次casbin权限</h3><p>说白了当这个东西是个缓存来用</p>
<p>services/login_service.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *loginService)</span> <span class="title">Info</span><span class="params">(tokenString <span class="keyword">string</span>)</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	claims, _ := middleware.ParseToken(tokenString)</span><br><span class="line">	username := claims[<span class="string">"username"</span>].(<span class="keyword">string</span>)</span><br><span class="line">	user, err := l.repo.Check(bson.M&#123;<span class="string">"username"</span>: username&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		response.Code = config.DBSelectErr</span><br><span class="line">		response.Msg = fmt.Sprintf(<span class="string">"查询数据失败：%v"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> user.IsAdmin &#123;</span><br><span class="line">		user.Roles = []<span class="keyword">string</span>&#123;<span class="string">"admin"</span>&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		menuCodes := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">5</span>)</span><br><span class="line">		l.repo.RemovePolicy(user.ID.Hex())  <span class="comment">// 删除该用户全部权限</span></span><br><span class="line">		<span class="keyword">for</span> _, id := <span class="keyword">range</span> user.Roles &#123;</span><br><span class="line">			role, _ := l.roleRepo.GetByID(id)</span><br><span class="line">			<span class="keyword">for</span> _, menuID := <span class="keyword">range</span> role.Menus &#123;</span><br><span class="line">				menu, _ := l.menuRepo.GetByID(menuID)</span><br><span class="line">				l.repo.LoadPolicy(user.ID.Hex(), menu)  <span class="comment">// 重新添加用户权限</span></span><br><span class="line">				menuCodes = <span class="built_in">append</span>(menuCodes, menu.Code)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		user.Roles = menuCodes</span><br><span class="line">	&#125;</span><br><span class="line">	response.Code = config.StatusOk</span><br><span class="line">	response.Msg = <span class="string">"success"</span></span><br><span class="line">	response.Data = user</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户登陆或者刷新后数据库保存的规则如下：</p>
<p><img src="/images/20191206093921.png" alt="20191206093921"></p>
<h3 id="增加中间件验证权限："><a href="#增加中间件验证权限：" class="headerlink" title="增加中间件验证权限："></a>增加中间件验证权限：</h3><p>middleware/casbin_middleware.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/dgrijalva/jwt-go"</span></span><br><span class="line">	<span class="string">"github.com/kataras/iris/v12"</span></span><br><span class="line">	<span class="string">"goms/config"</span></span><br><span class="line">	<span class="string">"goms/datamodels"</span></span><br><span class="line">	<span class="string">"goms/datasource"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CasbinHandler</span><span class="params">(ctx iris.Context)</span></span> &#123;</span><br><span class="line">	token := ctx.Values().Get(<span class="string">"jwt"</span>).(*jwt.Token)</span><br><span class="line">	claims := token.Claims.(jwt.MapClaims)</span><br><span class="line">	userID := claims[<span class="string">"userId"</span>]</span><br><span class="line">	isAdmin := claims[<span class="string">"isAdmin"</span>].(<span class="keyword">bool</span>)</span><br><span class="line">	url := ctx.Path()</span><br><span class="line">	method := ctx.Method()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !isAdmin &#123;</span><br><span class="line">		enforcer := datasource.GetEnforce()</span><br><span class="line">		enforcer.LoadPolicy()</span><br><span class="line">		ok, _ := enforcer.Enforce(userID, url, method)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			ctx.StopExecution()</span><br><span class="line">			response := &amp;datamodels.Response&#123;</span><br><span class="line">				Code: config.AccessDenied,</span><br><span class="line">				Msg:  <span class="string">"没有权限！"</span>,</span><br><span class="line">			&#125;</span><br><span class="line">			ctx.JSON(response)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.Next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="把中间件添加进路由"><a href="#把中间件添加进路由" class="headerlink" title="把中间件添加进路由"></a>把中间件添加进路由</h3><p>route/route.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> route</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/kataras/iris/v12"</span></span><br><span class="line">	<span class="string">"github.com/kataras/iris/v12/mvc"</span></span><br><span class="line">	<span class="string">"goms/controllers"</span></span><br><span class="line">	<span class="string">"goms/middleware"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitRoute</span><span class="params">(app *iris.Application)</span></span> &#123;</span><br><span class="line">	mvc.Configure(app.Party(<span class="string">"/account"</span>), <span class="function"><span class="keyword">func</span><span class="params">(m *mvc.Application)</span></span> &#123;</span><br><span class="line">		m.Handle(controllers.NewLoginController())</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	app.Use(middleware.JwtHandler().Serve)</span><br><span class="line">	app.Use(middleware.CasbinHandler)</span><br><span class="line"></span><br><span class="line">	bathPath := <span class="string">"/api/v1"</span></span><br><span class="line">	mvc.Configure(app.Party(bathPath+<span class="string">"/games"</span>), <span class="function"><span class="keyword">func</span><span class="params">(m *mvc.Application)</span></span> &#123;</span><br><span class="line">		m.Handle(controllers.NewGameController())</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大功告成~</p>
]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>iris</tag>
        <tag>casbin</tag>
      </tags>
  </entry>
  <entry>
    <title>golang iris 学习二:添加Jwt验证</title>
    <url>/2019/11/28/golang-iris-%E5%AD%A6%E4%B9%A0%E4%BA%8C-%E6%B7%BB%E5%8A%A0Jwt%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<p><a href="https://blog.wangjunfeng.com/post/golang-jwt/" target="_blank" rel="noopener">Jwt科普</a> </p>
<h3 id="在开始之前"><a href="#在开始之前" class="headerlink" title="在开始之前"></a>在开始之前</h3><p>先把</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &quot;github.com/kataras/iris&quot;</span><br></pre></td></tr></table></figure>
<p>这个为库替换成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &quot;github.com/kataras/iris/v12&quot;</span><br></pre></td></tr></table></figure>
<p>要不然在使用Jwt中间件的时候会报错</p>
<h3 id="先加个配置"><a href="#先加个配置" class="headerlink" title="先加个配置"></a>先加个配置</h3><p>config.yml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jwt:</span><br><span class="line">  SecretKey: sdfadfasdfdas</span><br><span class="line">  exp: 480</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>定义一个Key和过期时间（以分钟为单位）</p>
<h3 id="解析配置"><a href="#解析配置" class="headerlink" title="解析配置"></a>解析配置</h3><p>config/config.go</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">type jwtConfig struct &#123;</span><br><span class="line">	SecretKey string `yaml:&quot;SecretKey&quot;`</span><br><span class="line">	Exp       int    `yaml:&quot;exp&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type globalConfig struct &#123;</span><br><span class="line">	Mongo mongoConfig `yaml:&quot;mongo&quot;`</span><br><span class="line">	Jwt   jwtConfig   `yaml:&quot;jwt&quot;`</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="撸个生成Token、解析Token及验证Toke的方法"><a href="#撸个生成Token、解析Token及验证Toke的方法" class="headerlink" title="撸个生成Token、解析Token及验证Toke的方法"></a>撸个生成Token、解析Token及验证Toke的方法</h3><p>middleware/jwt_middleware.go</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import (</span><br><span class="line">	&quot;github.com/dgrijalva/jwt-go&quot;</span><br><span class="line">	jwtmiddleware &quot;github.com/iris-contrib/middleware/jwt&quot;</span><br><span class="line">	&quot;github.com/kataras/iris/v12/context&quot;</span><br><span class="line">	&quot;goms/config&quot;</span><br><span class="line">	&quot;goms/datamodels&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">	secretKey = []byte(config.GConfig.Jwt.SecretKey)</span><br><span class="line">	exp       = config.GConfig.Jwt.Exp</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 生成token</span><br><span class="line">func CreateToken(userId, username string) (tokenString string, err error) &#123;</span><br><span class="line">	token := jwt.New(jwt.SigningMethodHS256)</span><br><span class="line"></span><br><span class="line">	claims := make(jwt.MapClaims)</span><br><span class="line">	claims[&quot;exp&quot;] = time.Now().Add(time.Minute * time.Duration(exp)).Unix()</span><br><span class="line">	claims[&quot;iat&quot;] = time.Now().Unix()</span><br><span class="line">	claims[&quot;username&quot;] = username</span><br><span class="line">	claims[&quot;userId&quot;] = userId</span><br><span class="line"></span><br><span class="line">	token.Claims = claims</span><br><span class="line">	tokenString, err = token.SignedString(secretKey)</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 解析token</span><br><span class="line">func ParseToken(tokenSrt string) (claims jwt.MapClaims, err error) &#123;</span><br><span class="line">	token, err := jwt.Parse(tokenSrt, func(*jwt.Token) (interface&#123;&#125;, error) &#123;</span><br><span class="line">		return secretKey, nil</span><br><span class="line">	&#125;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		return nil, err</span><br><span class="line">	&#125;</span><br><span class="line">	claims = token.Claims.(jwt.MapClaims)</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// jwt验证失败返回内容</span><br><span class="line">func OnError(ctx context.Context, err error) &#123;</span><br><span class="line">	if err == nil &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx.StopExecution()</span><br><span class="line">	response := &amp;datamodels.Response&#123;</span><br><span class="line">		Code: 50008,</span><br><span class="line">		Msg:  err.Error(),</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.JSON(response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 验证Token</span><br><span class="line">func JwtHandler() *jwtmiddleware.Middleware &#123;</span><br><span class="line">	return jwtmiddleware.New(jwtmiddleware.Config&#123;</span><br><span class="line">		ValidationKeyGetter: func(token *jwt.Token) (i interface&#123;&#125;, e error) &#123;</span><br><span class="line">			return secretKey, nil</span><br><span class="line">		&#125;,</span><br><span class="line">		ErrorHandler:  OnError,</span><br><span class="line">		SigningMethod: jwt.SigningMethodHS256,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑"></a>业务逻辑</h3><p>因为还没有用户表，就不做验证了，随便返回先<br>services/login_service.go</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package services</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;goms/datamodels&quot;</span><br><span class="line">	&quot;goms/middleware&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type LoginService interface &#123;</span><br><span class="line">	Login(userId, username string) (response datamodels.Response)</span><br><span class="line">	Info(username string) (response datamodels.Response)</span><br><span class="line">	Logout() (response datamodels.Response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type loginService struct &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewUserService() LoginService &#123;</span><br><span class="line">	return &amp;loginService&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (u *loginService) Login(userId, username string) (response datamodels.Response) &#123;</span><br><span class="line">	token, err := middleware.CreateToken(userId, username)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		response.Code = 50001</span><br><span class="line">		response.Msg = fmt.Sprintf(&quot;用户登陆失败：%v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	response.Code = 20000</span><br><span class="line">	response.Msg = &quot;Login success&quot;</span><br><span class="line">	data := map[string]string&#123;</span><br><span class="line">		&quot;token&quot;: token,</span><br><span class="line">	&#125;</span><br><span class="line">	response.Data = data</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (u *loginService) Info(tokenString string) (response datamodels.Response) &#123;</span><br><span class="line">	claims, _ := middleware.ParseToken(tokenString)</span><br><span class="line">	username := claims[&quot;username&quot;].(string)</span><br><span class="line"></span><br><span class="line">	response.Code = 20000</span><br><span class="line">	response.Msg = &quot;success&quot;</span><br><span class="line">	response.Data = map[string]interface&#123;&#125;&#123;</span><br><span class="line">		&quot;avatar&quot;:   &quot;https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif&quot;,</span><br><span class="line">		&quot;id&quot;:       &quot;5d917402a0096e54c0140f07&quot;,</span><br><span class="line">		&quot;username&quot;: username,</span><br><span class="line">		&quot;roles&quot;:    []string&#123;&quot;admin&quot;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (u *loginService) Logout() (response datamodels.Response) &#123;</span><br><span class="line">	response.Code = 20000</span><br><span class="line">	response.Msg = &quot;Logout success&quot;</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Web请求"><a href="#Web请求" class="headerlink" title="Web请求"></a>Web请求</h3><p>暂时还没有验证用户信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package controllers</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;github.com/kataras/iris/v12&quot;</span><br><span class="line">	&quot;goms/datamodels&quot;</span><br><span class="line">	services2 &quot;goms/services&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type LoginController struct &#123;</span><br><span class="line">	Ctx     iris.Context</span><br><span class="line">	Service services2.LoginService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewLoginController() *LoginController &#123;</span><br><span class="line">	return &amp;LoginController&#123;</span><br><span class="line">		Service: services2.NewUserService(),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (u *LoginController) PostLogin() (response datamodels.Response) &#123;</span><br><span class="line">	return u.Service.Login(&quot;xxxx&quot;, &quot;wisp&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (u *LoginController) PostLogout() (response datamodels.Response) &#123;</span><br><span class="line">	return u.Service.Logout()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (u *LoginController) GetInfo() (response datamodels.Response) &#123;</span><br><span class="line">	tokenString := u.Ctx.URLParam(&quot;token&quot;)</span><br><span class="line">	return u.Service.Info(tokenString)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="路由添加Jwt验证"><a href="#路由添加Jwt验证" class="headerlink" title="路由添加Jwt验证"></a>路由添加Jwt验证</h3><p>route/route.go</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package route</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;github.com/kataras/iris/v12&quot;</span><br><span class="line">	&quot;github.com/kataras/iris/v12/mvc&quot;</span><br><span class="line">	&quot;goms/controllers&quot;</span><br><span class="line">	&quot;goms/middleware&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func InitRoute(app *iris.Application) &#123;</span><br><span class="line">	mvc.Configure(app.Party(&quot;/user&quot;), func(m *mvc.Application) &#123;</span><br><span class="line">		m.Handle(controllers.NewLoginController())</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	bathPath := &quot;/api/v1&quot;</span><br><span class="line">	mvc.Configure(app.Party(bathPath+&quot;/games&quot;), func(m *mvc.Application) &#123;</span><br><span class="line">		m.Router.Use(middleware.JwtHandler().Serve)</span><br><span class="line">		m.Handle(controllers.NewGameController())</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="来一波测试"><a href="#来一波测试" class="headerlink" title="来一波测试"></a>来一波测试</h3><p>main_test.go</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;encoding/json&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;github.com/kataras/iris/v12/httptest&quot;</span><br><span class="line">	&quot;goms/datamodels&quot;</span><br><span class="line">	&quot;testing&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func getJwtHeaders(t *testing.T) map[string]string &#123;</span><br><span class="line">	app := newApp()</span><br><span class="line">	e := httptest.New(t, app)</span><br><span class="line">	response := datamodels.Response&#123;&#125;</span><br><span class="line">	body := e.POST(&quot;/user/login&quot;).Expect().Status(httptest.StatusOK).Body().Raw()</span><br><span class="line">	json.Unmarshal([]byte(body), &amp;response)</span><br><span class="line">	token := response.Data.(map[string]interface&#123;&#125;)[&quot;token&quot;].(string)</span><br><span class="line">	tokenHeaders := map[string]string&#123;</span><br><span class="line">		&quot;Authorization&quot;: fmt.Sprintf(&quot;Bearer %s&quot;, token),</span><br><span class="line">	&#125;</span><br><span class="line">	return tokenHeaders</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func TestNewApp(t *testing.T) &#123;</span><br><span class="line">	app := newApp()</span><br><span class="line">	e := httptest.New(t, app)</span><br><span class="line">	e.POST(&quot;/user/login&quot;).Expect().Status(httptest.StatusOK).JSON().</span><br><span class="line">		Object().ContainsKey(&quot;code&quot;).ValueEqual(&quot;code&quot;, 20000)</span><br><span class="line"></span><br><span class="line">	tokenHeaders := getJwtHeaders(t)</span><br><span class="line"></span><br><span class="line">	e.POST(&quot;/api/v1/games&quot;).Expect().Status(httptest.StatusOK).JSON().</span><br><span class="line">		Object().ContainsKey(&quot;code&quot;).ValueEqual(&quot;code&quot;, 50008)</span><br><span class="line">	e.POST(&quot;/api/v1/games&quot;).WithHeaders(tokenHeaders).Expect().Status(httptest.StatusOK).JSON().</span><br><span class="line">		Object().ContainsKey(&quot;code&quot;).ValueEqual(&quot;code&quot;, 20000)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>go test验证一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wisp@wisp-System-Product-Name:~/go/src/goms$ go test -v</span><br><span class="line">=== RUN   TestNewApp</span><br><span class="line">--- PASS: TestNewApp (0.00s)</span><br><span class="line">PASS</span><br><span class="line">ok      goms    0.012s</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>iris</tag>
        <tag>jwt</tag>
      </tags>
  </entry>
  <entry>
    <title>python 操作excel</title>
    <url>/2019/11/27/python-%E6%93%8D%E4%BD%9Cexcel/</url>
    <content><![CDATA[<h3 id="安装第三方库："><a href="#安装第三方库：" class="headerlink" title="安装第三方库："></a>安装第三方库：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install openpyxl</span><br></pre></td></tr></table></figure>

<h3 id="存Excel文件："><a href="#存Excel文件：" class="headerlink" title="存Excel文件："></a>存Excel文件：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from openpyxl import Workbook</span><br><span class="line"> </span><br><span class="line">workbook = Workbook()</span><br><span class="line">booksheet = workbook.active     #获取当前活跃的sheet,默认是第一个sheet</span><br><span class="line">#存第一行单元格cell(1,1)</span><br><span class="line">booksheet.cell(1,1).value = 6   #这个方法索引从1开始</span><br><span class="line">booksheet.cell(&quot;B1&quot;).value = 7</span><br><span class="line">#存一行数据</span><br><span class="line">booksheet.append([11,87])</span><br><span class="line">workbook.save(&quot;test_openpyxl.xlsx&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="读Excel文件"><a href="#读Excel文件" class="headerlink" title="读Excel文件"></a>读Excel文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from openpyxl import load_workbook</span><br><span class="line"> </span><br><span class="line">workbook = load_workbook(&apos;D:\\Py_exercise\\test_openpyxl.xlsx&apos;)</span><br><span class="line">#booksheet = workbook.active                #获取当前活跃的sheet,默认是第一个sheet</span><br><span class="line">sheets = workbook.get_sheet_names()         #从名称获取sheet</span><br><span class="line">booksheet = workbook.get_sheet_by_name(sheets[0])</span><br><span class="line"> </span><br><span class="line">rows = booksheet.rows</span><br><span class="line">columns = booksheet.columns</span><br><span class="line">#迭代所有的行</span><br><span class="line">for row in rows:</span><br><span class="line">    line = [col.value for col in row]</span><br><span class="line"> </span><br><span class="line">#通过坐标读取值</span><br><span class="line">cell_11 = booksheet.cell(&apos;A1&apos;).value</span><br><span class="line">cell_11 = booksheet.cell(row=1, column=1).value</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>golang iris 学习一: 使用MVC模式+Mongo数据库</title>
    <url>/2019/11/22/golang-iris-%E5%AD%A6%E4%B9%A0%E4%B8%80-%E4%BD%BF%E7%94%A8MVC%E6%A8%A1%E5%BC%8F-Mongo%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    <content><![CDATA[<p>最近有时间，重新把Golang学习了一下，得搞点东西练练手，看着能不能用Golang Iris把Python Flask的后台重写一下，刚好golang更新了mod模式，试用一把！！！<br>系统环境：ubuntu18.04<br>golang版本：1.13<br>mongo: 随便docker run出来的</p>
<a id="more"></a>

<p>目录结构：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── config</span><br><span class="line">│   └── config.go</span><br><span class="line">├── config.yml</span><br><span class="line">├── controllers</span><br><span class="line">│   └── game_controller.go</span><br><span class="line">├── datamodels</span><br><span class="line">│   ├── game.go</span><br><span class="line">│   └── response.go</span><br><span class="line">├── datasource</span><br><span class="line">│   └── mongo.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── main.go</span><br><span class="line">├── repo</span><br><span class="line">│   └── game_repo.go</span><br><span class="line">├── route</span><br><span class="line">│   └── route.go</span><br><span class="line">└── services</span><br><span class="line">    └── game_service.go</span><br></pre></td></tr></table></figure>

<p>先定义一个模型吧，就是跟Python SQLALCHEMY的数据库结构一个道理，来个简单的走起：</p>
<p>datamodels目录存放数据模型</p>
<p>datamodels/game.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> datamodels</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"gopkg.in/mgo.v2/bson"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Game <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID       bson.ObjectId <span class="string">`json:"_id" bson:"_id"`</span></span><br><span class="line">    Name     <span class="keyword">string</span>        <span class="string">`json:"name" bson:"name"`</span></span><br><span class="line">    GameCode <span class="keyword">string</span>        <span class="string">`json:"gamecode" bson:"gamecode"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义一个通用数据返回模型，返回给前端用的</p>
<p>datamodels/response.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> datamodels</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Response <span class="keyword">struct</span> &#123;</span><br><span class="line">	Code <span class="keyword">int</span>         <span class="string">`json:"code"`</span></span><br><span class="line">	Msg  <span class="keyword">string</span>      <span class="string">`json:"msg"`</span></span><br><span class="line">	Data <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:"data"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后得连接数据库，先搞份数据库配置：</p>
<p>config.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mongo:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">27017</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">~</span></span><br><span class="line"><span class="attr">  pass:</span> <span class="string">~</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">oms</span></span><br></pre></td></tr></table></figure>

<p>然后把配置文件转成结构体</p>
<p>config/config.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> config</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"gopkg.in/yaml.v2"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> mongoConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Host <span class="keyword">string</span> <span class="string">`yaml:"host"`</span></span><br><span class="line">	Port <span class="keyword">int</span>    <span class="string">`yaml:"port"`</span></span><br><span class="line">	User <span class="keyword">string</span> <span class="string">`yaml:"user"`</span></span><br><span class="line">	Pass <span class="keyword">string</span> <span class="string">`yaml:"pass"`</span></span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`yaml:"name"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> globalConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Mongo mongoConfig <span class="string">`yaml:"mongo"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> GConfig = &amp;globalConfig&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	yamlFile, err := ioutil.ReadFile(<span class="string">"config.yml"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = yaml.Unmarshal(yamlFile, GConfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"Unmarshal: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着需要连接数据库</p>
<p>datasource目录存放初始化数据库连接</p>
<p>datasource/mongo.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> datasource</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"goms/config"</span></span><br><span class="line">	<span class="string">"gopkg.in/mgo.v2"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	session *mgo.Session</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dialInfo := &amp;mgo.DialInfo&#123;</span><br><span class="line">		Addrs:          []<span class="keyword">string</span>&#123;config.GConfig.Mongo.Host&#125;,</span><br><span class="line">		Direct:         <span class="literal">false</span>,</span><br><span class="line">		Timeout:        time.Second * <span class="number">60</span>,</span><br><span class="line">		FailFast:       <span class="literal">false</span>,</span><br><span class="line">		Database:       config.GConfig.Mongo.Name,</span><br><span class="line">		ReplicaSetName: <span class="string">""</span>,</span><br><span class="line">		Source:         <span class="string">""</span>,</span><br><span class="line">		Service:        <span class="string">""</span>,</span><br><span class="line">		ServiceHost:    <span class="string">""</span>,</span><br><span class="line">		Mechanism:      <span class="string">""</span>,</span><br><span class="line">		Username:       <span class="string">""</span>,</span><br><span class="line">		Password:       <span class="string">""</span>,</span><br><span class="line">		PoolLimit:      <span class="number">4096</span>,</span><br><span class="line">		DialServer:     <span class="literal">nil</span>,</span><br><span class="line">		Dial:           <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	sess, err := mgo.DialWithInfo(dialInfo)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	session = sess</span><br><span class="line">	session.SetMode(mgo.Monotonic, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SessionStore <span class="keyword">struct</span> &#123;</span><br><span class="line">	session *mgo.Session</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSessionStore</span><span class="params">()</span> *<span class="title">SessionStore</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;SessionStore&#123;</span><br><span class="line">		session: session.Copy(),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SessionStore)</span> <span class="title">C</span><span class="params">(name <span class="keyword">string</span>)</span> *<span class="title">mgo</span>.<span class="title">Collection</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> s.session.DB(config.GConfig.Mongo.Name).C(name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SessionStore)</span> <span class="title">Close</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s.session.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetErrNotFound</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> mgo.ErrNotFound</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来个CRUD操作</p>
<p>repo目录存放操作数据库的方法</p>
<p>repo/game_repo.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> repo</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"goms/datamodels"</span></span><br><span class="line">	<span class="string">"goms/datasource"</span></span><br><span class="line">	<span class="string">"gopkg.in/mgo.v2/bson"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GamesRepository <span class="keyword">interface</span> &#123;</span><br><span class="line">	List(query <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;) (games []datamodels.Game, err error)</span><br><span class="line">	Save(game datamodels.Game) (err error)</span><br><span class="line">	GetByID(id <span class="keyword">string</span>) (game datamodels.Game, err error)</span><br><span class="line">	DeleteByID(id <span class="keyword">string</span>) (err error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> gamesRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">	collection <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGamesRepository</span><span class="params">()</span> <span class="title">GamesRepository</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;gamesRepository&#123;</span><br><span class="line">		collection: <span class="string">"project_games"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *gamesRepository)</span> <span class="title">List</span><span class="params">(query <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(games []datamodels.Game, err error)</span></span> &#123;</span><br><span class="line">	db := datasource.NewSessionStore()</span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line">	col := db.C(g.collection)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err = col.Find(<span class="literal">nil</span>).All(&amp;games); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err.Error() != datasource.GetErrNotFound().Error() &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *gamesRepository)</span> <span class="title">Save</span><span class="params">(game datamodels.Game)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	db := datasource.NewSessionStore()</span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line">	col := db.C(g.collection)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> game.ID.Hex() == <span class="string">""</span> &#123;</span><br><span class="line">		game.ID = bson.NewObjectId()</span><br><span class="line">		err = col.Insert(game)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		err = col.Update(bson.M&#123;<span class="string">"_id"</span>: game.ID&#125;, game)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *gamesRepository)</span> <span class="title">GetByID</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(game datamodels.Game, err error)</span></span> &#123;</span><br><span class="line">	db := datasource.NewSessionStore()</span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line">	col := db.C(g.collection)</span><br><span class="line"></span><br><span class="line">	err = col.FindId(bson.ObjectIdHex(id)).One(&amp;game)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *gamesRepository)</span> <span class="title">DeleteByID</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	db := datasource.NewSessionStore()</span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line">	col := db.C(g.collection)</span><br><span class="line"></span><br><span class="line">	err = col.RemoveId(bson.ObjectIdHex(id))</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service目录调用repo方法得出最后的结果并整理</p>
<p>service/game_service.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> services</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"goms/datamodels"</span></span><br><span class="line">	<span class="string">"goms/repo"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GameService <span class="keyword">interface</span> &#123;</span><br><span class="line">	List(m <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;) (response datamodels.Response)</span><br><span class="line">	Save(game datamodels.Game) (response datamodels.Response)</span><br><span class="line">	GetByID(id <span class="keyword">string</span>) (response datamodels.Response)</span><br><span class="line">	DeleteByID(id <span class="keyword">string</span>) (response datamodels.Response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> gameService <span class="keyword">struct</span> &#123;</span><br><span class="line">	repo repo.GamesRepository</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gameRepo = repo.NewGamesRepository()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGameService</span><span class="params">()</span> <span class="title">GameService</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;gameService&#123;</span><br><span class="line">		repo: gameRepo,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *gameService)</span> <span class="title">List</span><span class="params">(m <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	games, _ := g.repo.List(<span class="literal">nil</span>)</span><br><span class="line">	response.Code = <span class="number">20000</span></span><br><span class="line">	response.Msg = <span class="string">"success"</span></span><br><span class="line">	response.Data = games</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *gameService)</span> <span class="title">Save</span><span class="params">(game datamodels.Game)</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	err := g.repo.Save(game)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		response.Code = <span class="number">30001</span></span><br><span class="line">		response.Msg = fmt.Sprintf(<span class="string">"保存数据失败：%v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	response.Code = <span class="number">20000</span></span><br><span class="line">	response.Msg = <span class="string">"success"</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *gameService)</span> <span class="title">GetByID</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	game, err := g.repo.GetByID(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		response.Code = <span class="number">30002</span></span><br><span class="line">		response.Msg = fmt.Sprintf(<span class="string">"查询数据失败：%v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	response.Code = <span class="number">20000</span></span><br><span class="line">	response.Msg = <span class="string">"success"</span></span><br><span class="line">	response.Data = game</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *gameService)</span> <span class="title">DeleteByID</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	err := g.repo.DeleteByID(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		response.Code = <span class="number">30003</span></span><br><span class="line">		response.Msg = fmt.Sprintf(<span class="string">"删除数据失败：%v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	response.Code = <span class="number">20000</span></span><br><span class="line">	response.Msg = <span class="string">"success"</span></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controllers响应Web请求</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> controllers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/kataras/iris"</span></span><br><span class="line">	<span class="string">"goms/datamodels"</span></span><br><span class="line">	<span class="string">"goms/services"</span></span><br><span class="line">	<span class="string">"gopkg.in/mgo.v2/bson"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GameController <span class="keyword">struct</span> &#123;</span><br><span class="line">	Ctx     iris.Context</span><br><span class="line">	Service services.GameService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGameController</span><span class="params">()</span> *<span class="title">GameController</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;GameController&#123;</span><br><span class="line">		Service: services.NewGameService(),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GameController)</span> <span class="title">Get</span><span class="params">()</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> g.Service.List(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GameController)</span> <span class="title">GetBy</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> g.Service.GetByID(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GameController)</span> <span class="title">DeleteBy</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> g.Service.DeleteByID(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GameController)</span> <span class="title">PutBy</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	game := datamodels.Game&#123;&#125;</span><br><span class="line">	err := g.Ctx.ReadJSON(&amp;game)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		response.Code = <span class="number">40001</span></span><br><span class="line">		response.Msg = fmt.Sprintf(<span class="string">"参数解析失败：%v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	game.ID = bson.ObjectIdHex(id)</span><br><span class="line">	<span class="keyword">return</span> g.Service.Save(game)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GameController)</span> <span class="title">Post</span><span class="params">()</span> <span class="params">(response datamodels.Response)</span></span> &#123;</span><br><span class="line">	game := datamodels.Game&#123;&#125;</span><br><span class="line">	err := g.Ctx.ReadJSON(&amp;game)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		response.Code = <span class="number">40001</span></span><br><span class="line">		response.Msg = fmt.Sprintf(<span class="string">"参数解析失败：%v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> g.Service.Save(game)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>route生成路由</p>
<p>route/route.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> route</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/kataras/iris"</span></span><br><span class="line">	<span class="string">"github.com/kataras/iris/mvc"</span></span><br><span class="line">	<span class="string">"goms/controllers"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitRoute</span><span class="params">(app *iris.Application)</span></span> &#123;</span><br><span class="line">	bathPath := <span class="string">"/api/v1"</span></span><br><span class="line">	mvc.New(app.Party(bathPath + <span class="string">"/games"</span>)).Handle(controllers.NewGameController())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>入口程序main.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="comment">//"github.com/iris-contrib/middleware/cors"</span></span><br><span class="line">	<span class="string">"github.com/kataras/iris"</span></span><br><span class="line">	<span class="string">"github.com/kataras/iris/middleware/logger"</span></span><br><span class="line">	<span class="string">"github.com/kataras/iris/middleware/recover"</span></span><br><span class="line">	<span class="string">"goms/route"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newApp</span><span class="params">()</span> *<span class="title">iris</span>.<span class="title">Application</span></span> &#123;</span><br><span class="line">	app := iris.New()</span><br><span class="line">	app.Use(<span class="built_in">recover</span>.New())</span><br><span class="line">	app.Use(logger.New())</span><br><span class="line">	app.AllowMethods(iris.MethodOptions)</span><br><span class="line">	<span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	app := newApp()</span><br><span class="line">	route.InitRoute(app)</span><br><span class="line">	app.Run(iris.Addr(<span class="string">":8080"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>go run跑起来~~</p>
]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>mongodb</tag>
        <tag>golang</tag>
        <tag>iris</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu wine 修改字体</title>
    <url>/2019/11/08/Ubuntu-wine-%E4%BF%AE%E6%94%B9%E5%AD%97%E4%BD%93/</url>
    <content><![CDATA[<p>今天在Ubuntu安装WPS的时候，修复WPS的字体报错，从Windows复制了几个字体过来重新生成了一下缓存，突然WineQQ和微信的字体也变了，摸索了一下修改一发Wine字体：</p>
<a id="more"></a>

<p>每个wine程序都有自己的一套字体目录：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/home/wisp/.deepinwine/Deepin-QQLight/drive_c/windows/Fonts/</span><br><span class="line">/home/wisp/.deepinwine/Deepin-WeChat/drive_c/windows/Fonts/</span><br></pre></td></tr></table></figure>

<p>下载simsun.ttc 字体，放到各个程序的Fonts目录下面去，然后创建注册表：<br>zh.reg</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REGEDIT4</span><br><span class="line">[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\FontSubstitutes]</span><br><span class="line">&quot;Arial&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Arial CE,238&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Arial CYR,204&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Arial Greek,161&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Arial TUR,162&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Courier New&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Courier New CE,238&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Courier New CYR,204&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Courier New Greek,161&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Courier New TUR,162&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;FixedSys&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Helv&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Helvetica&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;MS Sans Serif&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;MS Shell Dlg&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;MS Shell Dlg 2&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;System&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Tahoma&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Times&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Times New Roman CE,238&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Times New Roman CYR,204&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Times New Roman Greek,161&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Times New Roman TUR,162&quot;=&quot;simsun&quot;</span><br><span class="line">&quot;Tms Rmn&quot;=&quot;simsun&quot;</span><br></pre></td></tr></table></figure>

<p>导入zh.reg</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WINEPREFIX=&quot;/home/wisp/.deepinwine/Deepin-QQLight/&quot; deepin-wine  regedit zh.reg</span><br><span class="line">WINEPREFIX=&quot;/home/wisp/.deepinwine/Deepin-WeChat/&quot; deepin-wine  regedit zh.reg</span><br></pre></td></tr></table></figure>

<p>打开QQ，喵喵效果<br>搞完收工~</p>
]]></content>
      <categories>
        <category>ubuntu</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>wine</tag>
      </tags>
  </entry>
  <entry>
    <title>Python Json序列化时时间处理</title>
    <url>/2019/11/06/Python-Json%E5%BA%8F%E5%88%97%E5%8C%96%E6%97%B6%E6%97%B6%E9%97%B4%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<p>在Python使用Json序列化字典的时候,如果遇到值是Datetime,Date格式的会报错,总不能手工一个个转,今天查了一下,可以使用dumps的default参数指定一个函数,loads的object_hook指定一个函数,解决这些转换问题</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import json</span><br><span class="line">from datetime import datetime, date</span><br><span class="line"></span><br><span class="line">def json_dumps_default(obj):</span><br><span class="line">    if isinstance(obj, datetime):</span><br><span class="line">        return obj.strftime(&apos;%Y-%m-%d %H:%M:%S&apos;)</span><br><span class="line">    elif isinstance(obj, date):</span><br><span class="line">        return obj.strftime(&apos;%Y-%m-%d&apos;)</span><br><span class="line">    else:</span><br><span class="line">        return obj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def json_loads_hook(dct):</span><br><span class="line">    for k, v in dct.items():</span><br><span class="line">        if k in [&quot;onlinedate&quot;, &quot;pre_onlinedate&quot;, &quot;mergedate&quot;]:</span><br><span class="line">            try:</span><br><span class="line">                dct[k] = datetime.strptime(v, &apos;%Y-%m-%d %H:%M:%S&apos;)</span><br><span class="line">            except:</span><br><span class="line">                pass</span><br><span class="line">    return dct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    data = &#123;&quot;onlinedate&quot;: &quot;2019-11-15 16:30:36&quot;, &quot;name&quot;: &quot;wisp888&quot;&#125;</span><br><span class="line"></span><br><span class="line">    d1 = json.dumps(data)</span><br><span class="line">    print(d1)</span><br><span class="line"></span><br><span class="line">    d2 = json.loads(d1, object_hook=json_loads_hook)</span><br><span class="line">    print(d2)</span><br><span class="line"></span><br><span class="line">    d3 = json.dumps(d2, default=json_dumps_default)</span><br><span class="line">    print(d3)</span><br></pre></td></tr></table></figure>

<p>结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;onlinedate&quot;: &quot;2019-11-15 16:30:36&quot;, &quot;name&quot;: &quot;wisp888&quot;&#125;</span><br><span class="line">&#123;&apos;onlinedate&apos;: datetime.datetime(2019, 11, 15, 16, 30, 36), &apos;name&apos;: &apos;wisp888&apos;&#125;</span><br><span class="line">&#123;&quot;onlinedate&quot;: &quot;2019-11-15 16:30:36&quot;, &quot;name&quot;: &quot;wisp888&quot;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodb 数据备份与恢复</title>
    <url>/2019/11/05/mongodb%20%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/</url>
    <content><![CDATA[<h3 id="mongodump-备份数据库"><a href="#mongodump-备份数据库" class="headerlink" title="mongodump 备份数据库"></a>mongodump 备份数据库</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./mongodump -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -o 文件存在路径</span><br></pre></td></tr></table></figure>
<ul>
<li>不指定-d 则导出所有数据库</li>
</ul>
<a id="more"></a>

<h3 id="mongorestore还原数据库"><a href="#mongorestore还原数据库" class="headerlink" title="mongorestore还原数据库"></a>mongorestore还原数据库</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./mongorestore -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 --drop 文件存在路径</span><br></pre></td></tr></table></figure>
<ul>
<li>–drop表示先删除所有记录，再导入备份</li>
</ul>
<h3 id="mongoexport-备份数据库指定表"><a href="#mongoexport-备份数据库指定表" class="headerlink" title="mongoexport 备份数据库指定表"></a>mongoexport 备份数据库指定表</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./mongoexport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 -f 字段 -q 条件导出 --type=csv -o 文件名</span><br></pre></td></tr></table></figure>
<ul>
<li>-f 导出指定字段，以逗号分割</li>
<li>-q 查询语句</li>
<li>–type 默认为json</li>
</ul>
<h3 id="mongoimport-导入表，或者表中部分字段"><a href="#mongoimport-导入表，或者表中部分字段" class="headerlink" title="mongoimport 导入表，或者表中部分字段"></a>mongoimport 导入表，或者表中部分字段</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --type=csv --upsert --file 文件名</span><br></pre></td></tr></table></figure>
<ul>
<li>–upsert 插入或者更新现有数据</li>
<li>–type 指定备份文件的类型</li>
<li>–headline 表示不导入首行</li>
</ul>
<h3 id="举个粟子"><a href="#举个粟子" class="headerlink" title="举个粟子"></a>举个粟子</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongodump    -d oms -o ./oms.db</span><br><span class="line">mongorestore -d oms --drop oms/</span><br><span class="line">mongoexport  -d oms -c project_channel -o ./project_channel</span><br><span class="line">mongoimport  -d oms -c project_channel project_channel</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>mongodb</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos7 部署flask + vue-element笔记</title>
    <url>/2019/10/31/Centos7%20%E9%83%A8%E7%BD%B2flask%20+%20vue-element%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h2><ul>
<li>/data/www/oms/server 后端</li>
<li>/data/www/oms/client  前端</li>
</ul>
<h2 id="部署vue前端"><a href="#部署vue前端" class="headerlink" title="部署vue前端"></a>部署vue前端</h2><h3 id="一、安装Nodejs"><a href="#一、安装Nodejs" class="headerlink" title="一、安装Nodejs"></a>一、安装Nodejs</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install nodejs</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="二、编译vue"><a href="#二、编译vue" class="headerlink" title="二、编译vue"></a>二、编译vue</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /data/www/oms/client</span><br><span class="line">npm install</span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure>
<h2 id="部署flask后端"><a href="#部署flask后端" class="headerlink" title="部署flask后端"></a>部署flask后端</h2><h3 id="一、安装配置virtualenv"><a href="#一、安装配置virtualenv" class="headerlink" title="一、安装配置virtualenv"></a>一、安装配置virtualenv</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /data/www/oms/server</span><br><span class="line">/usr/local/python3/bin/pip3 install virtualenv</span><br><span class="line">/usr/local/python3/bin/virtualenv --no-site-packages venv</span><br><span class="line">source venv/bin/activate    # 进入虚拟环境</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install Gunicorn</span><br><span class="line">deactivate    # 退出虚拟环境</span><br></pre></td></tr></table></figure>
<h3 id="二、安装配置supervistord"><a href="#二、安装配置supervistord" class="headerlink" title="二、安装配置supervistord"></a>二、安装配置supervistord</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/usr/local/python3/bin/pip3 install supervisor</span><br><span class="line">/usr/local/python3/bin/echo_supervisord_conf &gt; /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>注意修改里面的配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[include]</span><br><span class="line">files = /etc/supervisord.d/*.ini</span><br></pre></td></tr></table></figure>
<p>添加flask进程/etc/supervisord.d/oms.ini</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[program:oms-app]</span><br><span class="line">; 下面命令中的 app:app 请修改为你实际部署时的项目名称</span><br><span class="line">command=/data/www/oms/server/venv/bin/gunicorn -w 64 --bind=127.0.0.1:17173 manager:app --access-logfile logs/access.log --error-logfile logs/error.log</span><br><span class="line">;</span><br><span class="line">; ; 下面的路径请修改为你创建的项目的根目录</span><br><span class="line">directory=/data/www/oms/server</span><br><span class="line"></span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">stopsignal=QUIT</span><br><span class="line">stopasgroup=true</span><br><span class="line">killasgroup=true</span><br><span class="line">;</span><br><span class="line">; 下面的用户请修改为创建该项目的用户</span><br><span class="line">user=root</span><br><span class="line">;</span><br><span class="line">redirect_stderr=true</span><br><span class="line">;</span><br><span class="line">; log 文件的路径你可以重新自定义</span><br><span class="line">stdout_logfile=/data/www/oms/server/supervisor.log</span><br><span class="line"></span><br><span class="line">; 解决编码问题</span><br><span class="line">[supervisord]</span><br><span class="line">environment=LC_ALL=&apos;en_US.UTF-8&apos;,LANG=&apos;en_US.UTF-8&apos;</span><br></pre></td></tr></table></figure>
<p>启动：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/usr/local/python3/bin/supervisord -c /etc/supervisord.conf</span><br><span class="line">/usr/local/python3/bin/supervisorctl update</span><br><span class="line">/usr/local/python3/bin/supervisorctl status</span><br></pre></td></tr></table></figure>
<h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  oms.lhp.com;</span><br><span class="line">        root  /data/www/oms/client/dist/;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line"></span><br><span class="line">        charset utf-8;</span><br><span class="line"></span><br><span class="line">        expires  30d;</span><br><span class="line"></span><br><span class="line">        location ~ /\.svn/     &#123;  return 403; &#125;</span><br><span class="line">        location ~* \.(sh|xls|doc|log|sh|sql|svn|tar|gz|svn-base) &#123;  root ~; deny all; &#125;</span><br><span class="line"></span><br><span class="line">        access_log  /data/nginx_logs/oms_client.access.log;</span><br><span class="line">        error_log   /data/nginx_logs/oms_client.error.log;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 10002;</span><br><span class="line">        server_name _;</span><br><span class="line">        return 403;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen      10002;</span><br><span class="line">        server_name oms.lhp.com;</span><br><span class="line"></span><br><span class="line">        access_log  /data/nginx_logs/oms_server.access.log;</span><br><span class="line">        error_log   /data/nginx_logs/oms_server.error.log;</span><br><span class="line"></span><br><span class="line">        location /docs &#123;</span><br><span class="line">                allow 183.63.86.194;</span><br><span class="line">                deny all;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        # flask中已设置跨域配置，Nginx不需要重复配置</span><br><span class="line">        proxy_hide_header &apos;Access-Control-Allow-Origin&apos;;</span><br><span class="line">        proxy_pass        http://127.0.0.1:17173;</span><br><span class="line">                proxy_http_version 1.1;</span><br><span class="line">                proxy_set_header   Host             $host;</span><br><span class="line">                proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">                proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">                proxy_set_header X-Forwarded-Host $host;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reload nginx</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl reload nginx</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>flask</category>
        <category>vue</category>
      </categories>
      <tags>
        <tag>centos7</tag>
        <tag>vue</tag>
        <tag>flask</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos7 mongodb安装笔记</title>
    <url>/2019/10/31/Centos7%20mongodb%E5%AE%89%E8%A3%85%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h3 id="配置系统源"><a href="#配置系统源" class="headerlink" title="配置系统源"></a>配置系统源</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat /etc/yum.repos.d/mongodb-org-4.2.repo</span><br><span class="line"></span><br><span class="line">[mongodb-org-4.2]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.2/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.2.asc</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y mongodb-org</span><br><span class="line">systemctl start mongod.service</span><br></pre></td></tr></table></figure>

<h3 id="配置用户"><a href="#配置用户" class="headerlink" title="配置用户"></a>配置用户</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.createUser(&#123; user:&quot;root&quot;, pwd:&quot;123456&quot;, roles:[&quot;root&quot;] &#125;)</span><br><span class="line">use test</span><br><span class="line">db.createUser(&#123; user:&quot;admin&quot;, pwd:&quot;123456&quot;, roles:[&quot;dbOwner&quot;] &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="修改配置文件-etc-mongod-conf"><a href="#修改配置文件-etc-mongod-conf" class="headerlink" title="修改配置文件/etc/mongod.conf"></a>修改配置文件/etc/mongod.conf</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mongod.conf</span><br><span class="line"></span><br><span class="line"># for documentation of all options, see:</span><br><span class="line">#   http://docs.mongodb.org/manual/reference/configuration-options/</span><br><span class="line"></span><br><span class="line"># where to write logging data.</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /var/log/mongodb/mongod.log</span><br><span class="line"></span><br><span class="line"># Where and how to store data.</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /data/mongo</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">#  engine:</span><br><span class="line">#  wiredTiger:</span><br><span class="line"></span><br><span class="line"># how the process runs</span><br><span class="line">processManagement:</span><br><span class="line">  fork: true  # fork and run in background</span><br><span class="line">  pidFilePath: /var/run/mongodb/mongod.pid  # location of pidfile</span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"># network interfaces</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">security:</span><br><span class="line">  authorization: &quot;enabled&quot;</span><br><span class="line"></span><br><span class="line">#operationProfiling:</span><br><span class="line"></span><br><span class="line">#replication:</span><br><span class="line"></span><br><span class="line">#sharding:</span><br><span class="line"></span><br><span class="line">## Enterprise-Only Options</span><br><span class="line"></span><br><span class="line">#auditLog:</span><br><span class="line"></span><br><span class="line">#snmp:</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>centos7</tag>
        <tag>mongodb</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2019/10/31/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
</search>
